<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>{% block title %}Archive System{% endblock %}</title>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/7.0.0/css/all.min.css" rel="stylesheet">
  {% load static %}
  {% csrf_token %}
  <meta name="csrf-token" content="{{ csrf_token }}">
  <script src="{% static 'js/base.js' %}" defer></script>
  <style>
    /* Hide chat history and menu buttons when sidebar is collapsed */
    #logo-sidebar.collapsed .chat-history-section,
    #logo-sidebar.collapsed .menu-button {
      display: none !important;
    }
    
    /* Hide text labels when collapsed but show icons */
    #logo-sidebar.collapsed .item-label {
      display: none;
    }
    
    /* Maintain flex layout when collapsed so user stays at bottom */
    #logo-sidebar.collapsed nav {
      flex: 1;
      display: flex;
      flex-direction: column;
    }
    
    /* Add spacer when collapsed to push user section to bottom */
    #logo-sidebar.collapsed nav::after {
      content: '';
      flex: 1;
    }
    
    /* Hide tooltips when sidebar is expanded */
    #logo-sidebar:not(.collapsed) .item-tooltip {
      display: none !important;
    }
  </style>
  <script>
    function deleteConversation(conversationId) {
      if (confirm('Are you sure you want to delete this conversation?')) {
        fetch(`/chat/delete/${conversationId}/`, {
          method: 'POST',
          headers: {
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
            'Content-Type': 'application/json',
          },
        })
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            location.reload(); // Reload to update the sidebar
          } else {
            alert('Error deleting conversation');
          }
        })
        .catch(error => {
          console.error('Error:', error);
          alert('Error deleting conversation');
        });
      }
    }
  </script>
  {% block scripts %}{% endblock %}
  {% block styles %}{% endblock %}
  <link rel="stylesheet" type="text/css" href="{% static 'css/base.css' %}">
  <style>
    /* Chat history item styling */
    .chat-history-item:hover {
      background-color: rgba(16, 185, 129, 0.05);
      border-radius: 8px;
    }
    
    .chat-history-item.active {
      background-color: rgba(16, 185, 129, 0.1);
      border-radius: 8px;
    }
    
    .chat-history-item a {
      transition: all 0.2s ease;
    }
    
    .chat-history-item:hover a {
      background-color: transparent !important;
    }
    
    /* Three-dot menu styling */
    .chat-menu-btn {
      transition: all 0.2s ease;
    }
    
    .chat-menu-btn:hover {
      background-color: rgba(0, 0, 0, 0.1);
    }
    
    /* Dropdown menu styling */
    [id^="chatMenu"] {
      box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
    }
  </style>
</head>
<body class="bg-gray-50">
    {% if not user.is_authenticated %}
    <!-- Navbar (only shows if NOT logged in) -->
    <nav class="bg-white text-green-600 p-4">
      <div class="container mx-auto flex justify-between items-center">
        <div class="flex items-center space-x-2">
          <img src="{% static 'img/fowse.png' %}" class="h-8 inline-block" alt="Fowse Logo" />
          <h1 class="text-xl font-bold text-green-600">
            Fowse
          </h1>
        </div>

        <div class="flex items-center space-x-4">
          <a href="{% url 'login' %}" id="loginNavBtn"
            class="ml-4 hover:bg-green-700 hover:text-white px-3 py-2 rounded-md cursor-pointer transition-colors duration-200">
            Login
          </a>
        </div>
      </div>
    </nav>
    {% endif %}

    {% if user.is_authenticated and not hide_sidebar %}
    <div class="min-h-screen flex bg-white">
    <!-- Sidebar (only shows if logged in) -->
    <aside id="logo-sidebar" class="fixed inset-y-0 left-0 z-40 bg-white shadow" aria-label="Sidebar">

      <div class="h-full flex flex-col bg-gray-200">
        <!-- Brand + Collapse -->
        <div class="flex items-center justify-between px-2.5 py-3 border-b border-gray-300">
          <button id="brandToggle"
            class="flex items-center space-x-2 px-2.5 py-2 w-full overflow-hidden focus:outline-none hover:opacity-90"
            type="button" aria-label="Toggle sidebar" aria-pressed="false">
            <img src="{% static 'img/fowse.png' %}"
           class="h-8 w-8 rounded-full object-cover inline-block" alt="Fowse Logo" />
            <span class="brand-text text-lg font-semibold whitespace-nowrap">Fowse</span>
          </button>
          <button id="collapseSidebar"
                  class="hidden sm:inline-flex items-center justify-center w-8 h-8 rounded hover:bg-gray-100 text-gray-600"
                  type="button" aria-label="Collapse sidebar" aria-expanded="true">
            <i class="fa-solid fa-angles-left text-sm"></i>
          </button>
        </div>

        <!-- Apps in Nav -->
        <nav class="px-2 py-2" style="height: calc(100vh - 140px); display: flex; flex-direction: column;"> <!-- px-2 py-3→px-2 py-2, using calculated height -->
          <!-- Navigation buttons -->
          <div class="space-y-1 flex-shrink-0">
            <a href="{% url 'search_form' %}"
              class="group relative flex items-center gap-2.5 px-2.5 py-2 rounded-md hover:bg-green-50 text-gray-800 transition-colors">
              <i class="fa-solid fa-pen-to-square text-base shrink-0"></i> <!-- text-lg→base -->
              <span class="item-label">Document</span>
              <span class="item-tooltip pointer-events-none absolute left-11 top-1/2 -translate-y-1/2 whitespace-nowrap rounded bg-gray-800 text-white text-xs px-2 py-1 opacity-0 group-hover:opacity-100">Document</span>
            </a>

            <a href="{% url 'dashboard' %}"
              class="group relative flex items-center gap-2.5 px-2.5 py-2 rounded-md hover:bg-green-50 text-gray-800 transition-colors">
              <i class="fa-regular fa-file text-base shrink-0"></i>
              <span class="item-label">New Chat</span>
              <span class="item-tooltip pointer-events-none absolute left-11 top-1/2 -translate-y-1/2 whitespace-nowrap rounded bg-gray-800 text-white text-xs px-2 py-1 opacity-0 group-hover:opacity-100">New Chat</span>
            </a>
          </div>

          <!-- Chat History Section -->
          <div class="pt-2 flex-1 chat-history-section" style="display: flex; flex-direction: column; min-height: 0;">
            <div class="item-label px-2.5 py-1 text-xs font-semibold text-gray-500 uppercase tracking-wider flex-shrink-0">History</div>
            <div id="chatHistory" class="space-y-1 overflow-y-auto" style="flex: 1; height: 0;">
              {% if conversations %}
                {% for conversation in conversations %}
                  <div class="group relative chat-history-item" data-conversation-id="{{ conversation.id }}" data-conversation-title="{{ conversation.title }}">
                    <a href="{% url 'dashboard_conversation' conversation.id %}"
                      class="flex items-center gap-2.5 px-2.5 py-2 rounded-md hover:bg-green-50 text-gray-800 transition-colors text-sm
                      {% if current_conversation and current_conversation.id == conversation.id %}bg-green-100{% endif %}">
                      <i class="fa-regular fa-message text-sm shrink-0"></i>
                      <span class="item-label truncate flex-1">{{ conversation.title }}</span>
                      <!-- Three dots menu button -->
                      <button onclick="showContextMenu(event, this.closest('.chat-history-item')); event.preventDefault(); event.stopPropagation();" 
                        class="opacity-0 group-hover:opacity-100 w-6 h-6 flex items-center justify-center text-gray-400 hover:text-gray-600 transition-all rounded hover:bg-gray-100 ml-1 menu-button">
                        <i class="fa-solid fa-ellipsis text-sm"></i>
                      </button>
                    </a>
                  </div>
                {% endfor %}
              {% else %}
                <p class="item-label px-2.5 py-2 text-xs text-gray-500">No conversations yet</p>
              {% endif %}
            </div>
          </div>
        </nav>

        <!-- User -->
        <div class="px-2 py-1 border-t flex-shrink-0"> <!-- py-2→py-1, added flex-shrink-0 -->
          <div class="group relative w-full overflow-visible">
            <button id="userMenuButton"
                    class="group relative flex items-center gap-2.5 px-2.5 py-1.5 w-full rounded-md hover:bg-green-50 text-gray-800 transition-colors"> <!-- py-2→py-1.5 -->
              <i class="fa-solid fa-user text-base shrink-0"></i>
              <span class="item-label">{{ user.username }}</span>
              <svg class="item-label w-4 h-4 ml-auto transition-transform duration-150" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
              </svg>
              <span class="item-tooltip pointer-events-none absolute left-11 top-1/2 -translate-y-1/2 whitespace-nowrap rounded bg-gray-800 text-white text-xs px-2 py-1 opacity-0 group-hover:opacity-100">{{ user.username }}</span>
            </button>

            <!-- Dropdown (upward by default; flyout when collapsed) -->
            <div id="userDropdown"
                  class="user-menu-panel hidden absolute left-0 bottom-full mb-2 w-full bg-white rounded-xl shadow-xl ring-1 ring-gray-200 py-2 z-60">
              <a href="{% url 'change_password' %}" class="block px-4 py-2 text-sm text-gray-800 hover:bg-gray-100 rounded-md">Change Password</a>
              <hr class="border-gray-200 my-1">
              <a href="{% url 'logout' %}" class="block px-4 py-2 text-sm text-gray-800 hover:bg-gray-100 rounded-md">Logout</a>
            </div>
          </div>
        </div>
      </div>
    </aside>
    {% endif %}

    <!-- Context Menu for Chat History -->
    <div id="chatContextMenu" class="hidden fixed bg-white rounded-lg shadow-lg border py-2 z-50 min-w-32">
      <button onclick="renameChatItem()" class="flex items-center gap-3 w-full px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 transition-colors">
        <i class="fa-solid fa-edit text-gray-500"></i>
        <span>Rename</span>
      </button>
      <button onclick="deleteChatItem()" class="flex items-center gap-3 w-full px-4 py-2 text-sm text-red-600 hover:bg-red-50 transition-colors">
        <i class="fa-solid fa-trash text-red-500"></i>
        <span>Delete</span>
      </button>
    </div>

    <!-- Delete Confirmation Modal -->
    <div id="deleteConfirmModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
      <div class="bg-white rounded-lg p-6 max-w-sm w-full mx-4 shadow-xl">
        <div class="flex items-center gap-3 mb-4">
          <div class="w-8 h-8 bg-red-100 rounded-full flex items-center justify-center">
            <i class="fa-solid fa-exclamation-triangle text-red-600"></i>
          </div>
          <h3 class="text-lg font-semibold text-gray-900">127.0.0.1:8000 says</h3>
        </div>
        <p class="text-gray-700 mb-6">Are you sure you want to delete this conversation?</p>
        <div class="flex gap-3 justify-end">
          <button onclick="cancelDelete()" class="px-4 py-2 bg-gray-500 text-white rounded hover:bg-gray-600 transition-colors">Cancel</button>
          <button onclick="confirmDelete()" class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700 transition-colors">OK</button>
        </div>
      </div>
    </div>

    <!-- Rename Modal -->
    <div id="renameModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
      <div class="bg-white rounded-lg p-6 max-w-sm w-full mx-4 shadow-xl">
        <h3 class="text-lg font-semibold text-gray-900 mb-4">Rename Conversation</h3>
        <input id="renameInput" type="text" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 mb-6" placeholder="Enter new name">
        <div class="flex gap-3 justify-end">
          <button onclick="cancelRename()" class="px-4 py-2 bg-gray-500 text-white rounded hover:bg-gray-600 transition-colors">Cancel</button>
          <button onclick="confirmRename()" class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700 transition-colors">Save</button>
        </div>
      </div>
    </div>

    <!-- PAGE-SPECIFIC CONTENT -->
    <div id="pageContent" class="flex-1 container mx-auto mt-8 {% if hide_sidebar %}no-sidebar{% endif %}">
      {% block content %}{% endblock %}
    </div>

    <script>
    let currentConversationId = null;
    let currentConversationTitle = null;

    // Get CSRF token
    function getCSRFToken() {
        return document.querySelector('meta[name="csrf-token"]').getAttribute('content');
    }

    // Context menu functions
    function showContextMenu(event, element) {
        event.preventDefault();
        event.stopPropagation();
        
        currentConversationId = element.dataset.conversationId;
        currentConversationTitle = element.dataset.conversationTitle;
        
        console.log('Opening context menu for:', currentConversationId, currentConversationTitle);
        
        const contextMenu = document.getElementById('chatContextMenu');
        contextMenu.classList.remove('hidden');
        
        // Position the context menu near the button that was clicked
        const buttonRect = event.target.closest('button').getBoundingClientRect();
        contextMenu.style.left = (buttonRect.right - contextMenu.offsetWidth) + 'px';
        contextMenu.style.top = (buttonRect.bottom + 5) + 'px';
        
        // Hide context menu when clicking elsewhere
        setTimeout(() => {
            document.addEventListener('click', hideContextMenu);
        }, 10);
    }

    function hideContextMenu() {
        const contextMenu = document.getElementById('chatContextMenu');
        contextMenu.classList.add('hidden');
        document.removeEventListener('click', hideContextMenu);
    }

    // Rename functions
    function renameChatItem() {
        hideContextMenu();
        document.getElementById('renameInput').value = currentConversationTitle;
        document.getElementById('renameModal').classList.remove('hidden');
    }

    function cancelRename() {
        document.getElementById('renameModal').classList.add('hidden');
    }

    function confirmRename() {
        const newTitle = document.getElementById('renameInput').value.trim();
        if (newTitle && newTitle !== currentConversationTitle) {
            // Send rename request
            fetch(`/chat/rename/${currentConversationId}/`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCSRFToken(),
                },
                body: JSON.stringify({ title: newTitle })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    location.reload(); // Refresh to show updated title
                } else {
                    alert('Error renaming conversation: ' + (data.error || 'Unknown error'));
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Error renaming conversation');
            });
        }
        document.getElementById('renameModal').classList.add('hidden');
    }

    // Delete functions
    function deleteChatItem() {
        console.log('Delete clicked for conversation:', currentConversationId);
        hideContextMenu();
        document.getElementById('deleteConfirmModal').classList.remove('hidden');
    }

    function cancelDelete() {
        document.getElementById('deleteConfirmModal').classList.add('hidden');
    }

    function confirmDelete() {
        console.log('Confirming delete for conversation:', currentConversationId);
        if (!currentConversationId) {
            alert('No conversation selected for deletion');
            return;
        }
        
        // Send delete request
        fetch(`/chat/delete/${currentConversationId}/`, {
            method: 'DELETE',
            headers: {
                'X-CSRFToken': getCSRFToken(),
            }
        })
        .then(response => {
            console.log('Delete response status:', response.status);
            return response.json();
        })
        .then(data => {
            console.log('Delete response data:', data);
            if (data.success) {
                location.reload(); // Refresh to remove deleted item
            } else {
                alert('Error deleting conversation: ' + (data.error || 'Unknown error'));
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error deleting conversation');
        });
        document.getElementById('deleteConfirmModal').classList.add('hidden');
    }

    // Legacy delete function (if still needed)
    function deleteConversation(conversationId) {
        currentConversationId = conversationId;
        document.getElementById('deleteConfirmModal').classList.remove('hidden');
    }

    // Debug: Check if conversations are loaded
    document.addEventListener('DOMContentLoaded', function() {
        const historyItems = document.querySelectorAll('.chat-history-item');
        console.log('Found', historyItems.length, 'chat history items');
    });
    </script>

</body>
