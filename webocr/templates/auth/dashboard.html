{% extends "base.html" %}

{% block title %}Smart Chat - Archive System{% endblock %}
{% block page_title %}Smart chat{% endblock %}

{% block content %}
<div class="min-h-screen">
    <!-- Header-->
<div id="greetingSection" class="h-screen flex items-center justify-center px-4 transition-all duration-700 ease-out">
    <div class="w-full max-w-3xl flex flex-col items-center space-y-8">
        <!-- Main title -->
        <div id="pageHeader" class="text-center transition-all duration-500">
            <h1 class="text-4xl sm:text-5xl font-extrabold tracking-wide text-green-700">
                How can I help you today?
            </h1>
        </div>

        <!-- Input area -->
        <div id="initialInputContainer" class="w-full transition-all duration-700 ease-out">
            <form id="chatForm" class="relative">
                <div class="flex items-center bg-white rounded-full shadow-lg border border-gray-200 px-6 py-4">
                    <input
                        type="text"
                        id="messageInput"
                        name="search_query"
                        placeholder="Ask anything..."
                        class="flex-1 border-none outline-none text-gray-800 placeholder-gray-400 bg-transparent text-lg"
                    />
                    <button
                        id="sendButton"
                        type="submit"
                        disabled
                        class="ml-4 w-10 h-10 bg-gray-300 disabled:bg-gray-300 disabled:cursor-not-allowed text-white rounded-full transition-all duration-200 flex items-center justify-center hover:bg-green-600 disabled:hover:bg-gray-300"
                    >
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"/>
                        </svg>
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>


    <!-- Conversation section (nakatago muna) -->
    <div id="conversationSection" class="hidden min-h-screen px-4 pt-4 pb-8">
        <div class="max-w-4xl mx-auto">
            <!-- Messages container -->
            <div id="messagesList" class="space-y-6 pb-32">
                <!-- Messages will be added here -->
            </div>
        </div>
    </div>

    <!-- Area ng conversation -->
    <div id="fixedInputArea" class="hidden fixed bottom-0 left-0 right-0 bg-white border-t border-gray-200 p-4 z-10">
        <div class="max-w-4xl mx-auto">
            <form id="chatFormActive" action="{% url 'search_documents' %}" method="POST" class="relative">
                {% csrf_token %}
                <div class="flex items-end bg-gray-50 rounded-2xl border border-gray-200 px-6 py-3">
                    <textarea
                        id="messageInputActive"
                        name="message"
                        placeholder="Ask anything..."
                        rows="1"
                        class="flex-1 border-none outline-none text-gray-800 placeholder-gray-400 bg-transparent resize-none overflow-y-auto max-h-32 min-h-[24px]"
                        style="scrollbar-width: thin; scrollbar-color: #cbd5e1 transparent;"
                    ></textarea>
                    <button
                        id="sendButtonActive"
                        type="submit"
                        disabled
                        class="ml-4 w-8 h-8 bg-gray-300 disabled:bg-gray-300 disabled:cursor-not-allowed text-white rounded-full transition-all duration-200 flex items-center justify-center hover:bg-green-600 disabled:hover:bg-gray-300 flex-shrink-0"
                    >
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"/>
                        </svg>
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Custom font and styles -->
<style>
    .font-custom-verdana { 
        font-family: Verdana, sans-serif; 
    }
    
    /* Smooth animations */
    .fade-in {
        animation: fadeIn 0.8s ease-out;
    }
    
    .slide-up {
        animation: slideUp 0.5s ease-out;
    }
    
    .message-appear {
        animation: messageAppear 0.4s ease-out;
    }
    
    @keyframes fadeIn {
        from { opacity: 0; transform: translateY(30px); }
        to { opacity: 1; transform: translateY(0); }
    }
    
    @keyframes slideUp {
        from { opacity: 0; transform: translateY(50px); }
        to { opacity: 1; transform: translateY(0); }
    }
    
    @keyframes messageAppear {
        from { opacity: 0; transform: translateY(20px) scale(0.95); }
        to { opacity: 1; transform: translateY(0) scale(1); }
    }
    
    .typing-indicator {
        animation: pulse 1.5s ease-in-out infinite;
    }
    
    .typing-dots span {
        animation: typingDots 1.4s infinite;
    }
    
    .typing-dots span:nth-child(2) {
        animation-delay: 0.2s;
    }
    
    .typing-dots span:nth-child(3) {
        animation-delay: 0.4s;
    }
    
    @keyframes typingDots {
        0%, 60%, 100% {
            opacity: 0.4;
            transform: translateY(0);
        }
        30% {
            opacity: 1;
            transform: translateY(-4px);
        }
    }
    
    /* Header fade based on scroll position */
    .header-fade {
        transition: opacity 0.3s ease-out, transform 0.3s ease-out;
    }
    
    /* Auto-resize textarea */
    .auto-resize {
        field-sizing: content;
    }
    
    /* Smooth scrolling */
    html {
        scroll-behavior: smooth;
    }
</style>

<script>
(function() {
    class ChatInterface {
        constructor() {
            this.greetingSection = document.getElementById('greetingSection');
            this.conversationSection = document.getElementById('conversationSection');
            this.fixedInputArea = document.getElementById('fixedInputArea');
            this.pageHeader = document.getElementById('pageHeader');
            
            // Initial form elements
            this.messageInput = document.getElementById('messageInput');
            this.sendButton = document.getElementById('sendButton');
            this.chatForm = document.getElementById('chatForm');
            
            // Chat form elements
            this.messageInputActive = document.getElementById('messageInputActive');
            this.sendButtonActive = document.getElementById('sendButtonActive');
            this.chatFormActive = document.getElementById('chatFormActive');
            this.messagesList = document.getElementById('messagesList');
            
            this.isFirstMessage = true;
            this.isTyping = false;
            
            this.initializeEventListeners();
            this.setupScrollEffects();
        }
        
        initializeEventListeners() {
            // Initial form submission
            this.chatForm.addEventListener('submit', (e) => {
                e.preventDefault();
                this.handleFirstMessage();
            });
            
            // Active chat form submission
            this.chatFormActive.addEventListener('submit', (e) => {
                e.preventDefault();
                this.handleSendMessage();
            });
            
            // Input changes for initial form
            this.messageInput.addEventListener('input', () => {
                this.updateSendButton(this.messageInput, this.sendButton);
            });
            
            // Input changes for active chat
            this.messageInputActive.addEventListener('input', () => {
                this.updateSendButton(this.messageInputActive, this.sendButtonActive);
                this.autoResize(this.messageInputActive);
            });
            
            // Enter key handling for textarea
            this.messageInputActive.addEventListener('keydown', (e) => {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    if (this.messageInputActive.value.trim() && !this.isTyping) {
                        this.handleSendMessage();
                    }
                }
            });
        }
        
        autoResize(textarea) {
            textarea.style.height = 'auto';
            const newHeight = Math.min(textarea.scrollHeight, 128); // max-h-32 = 128px
            textarea.style.height = newHeight + 'px';
        }
        
        setupScrollEffects() {
            let ticking = false;
            
            window.addEventListener('scroll', () => {
                if (!ticking) {
                    requestAnimationFrame(() => {
                        this.handleScrollEffects();
                        ticking = false;
                    });
                    ticking = true;
                }
            });
        }
        
        handleScrollEffects() {
            if (!this.isFirstMessage) {
                const scrollY = window.scrollY;
                const windowHeight = window.innerHeight;
                const greetingBottom = this.greetingSection.offsetTop + this.greetingSection.offsetHeight;
                
                // Oppasity setting ng greeting habang iniiscroll down
                const fadeStart = windowHeight * 0.3; // start ng fade which is 30%
                const fadeEnd = windowHeight * 0.8;   // total fade out at 80%
                
                if (scrollY <= fadeStart) {
                    // Fully visible
                    this.pageHeader.style.opacity = '1';
                    this.pageHeader.style.transform = 'translateY(0)';
                } else if (scrollY >= fadeEnd) {
                    // Fully faded
                    this.pageHeader.style.opacity = '0.3';
                    this.pageHeader.style.transform = 'translateY(-10px)';
                } else {
                    // Gradually fade
                    const fadeProgress = (scrollY - fadeStart) / (fadeEnd - fadeStart);
                    const opacity = 1 - (fadeProgress * 0.7); // Fade to 0.3, not 0
                    const translateY = fadeProgress * -10;
                    
                    this.pageHeader.style.opacity = opacity;
                    this.pageHeader.style.transform = `translateY(${translateY}px)`;
                }
            }
        }
        
        updateSendButton(input, button) {
            const hasText = input.value.trim().length > 0;
            button.disabled = !hasText || this.isTyping;
            
            if (hasText && !this.isTyping) {
                button.classList.remove('bg-gray-300');
                button.classList.add('bg-green-600');
            } else {
                button.classList.add('bg-gray-300');
                button.classList.remove('bg-green-600');
            }
        }
        
        async handleFirstMessage() {
            const message = this.messageInput.value.trim();
            if (!message || this.isTyping) return;
            
            // Store the message
            const userMessage = message;
            
            // Show conversation section
            this.conversationSection.classList.remove('hidden');
            
            // Add scroll effects class to header
            this.pageHeader.classList.add('header-fade');
            
            // Animate the original input box moving down and fading out
            const initialInputContainer = document.getElementById('initialInputContainer');
            
            // Create a clone of the input box for animation
            const inputClone = initialInputContainer.cloneNode(true);
            inputClone.style.position = 'fixed';
            inputClone.style.top = initialInputContainer.getBoundingClientRect().top + 'px';
            inputClone.style.left = initialInputContainer.getBoundingClientRect().left + 'px';
            inputClone.style.width = initialInputContainer.getBoundingClientRect().width + 'px';
            inputClone.style.zIndex = '1000';
            inputClone.style.pointerEvents = 'none';
            document.body.appendChild(inputClone);
            
            // Hide the original input immediately
            initialInputContainer.style.opacity = '0';
            initialInputContainer.style.visibility = 'hidden';
            
            // Add the first message
            this.addMessage(userMessage, 'user');
            
            // Show fixed input area (hidden initially)
            this.fixedInputArea.classList.remove('hidden');
            this.fixedInputArea.style.transform = 'translateY(100%)';
            this.fixedInputArea.style.opacity = '0';
            
            // Animate the clone moving to bottom
            setTimeout(() => {
                const bottomPosition = window.innerHeight - this.fixedInputArea.offsetHeight - 16;
                inputClone.style.transition = 'all 0.8s cubic-bezier(0.4, 0, 0.2, 1)';
                inputClone.style.top = bottomPosition + 'px';
                inputClone.style.opacity = '0.7';
                inputClone.style.transform = 'scale(0.95)';
            }, 100);
            
            // Smooth scroll to conversation section
            setTimeout(() => {
                this.conversationSection.scrollIntoView({ 
                    behavior: 'smooth',
                    block: 'start'
                });
            }, 200);
            
            // Remove clone and show the real fixed input
            setTimeout(() => {
                inputClone.remove();
                this.fixedInputArea.style.transform = 'translateY(0)';
                this.fixedInputArea.style.opacity = '1';
                this.fixedInputArea.style.transition = 'all 0.4s ease-out';
            }, 800);
            
            // Focus on the new input after animations
            setTimeout(() => {
                this.messageInputActive.focus();
            }, 1200);
            
            // Show typing and respond
            this.showTypingIndicator();
            this.simulateAIResponse();
            
            this.isFirstMessage = false;
        }
        
        async handleSendMessage() {
            const message = this.messageInputActive.value.trim();
            if (!message || this.isTyping) return;
            
            // Add user message
            this.addMessage(message, 'user');
            
            // Clear input and reset height
            this.messageInputActive.value = '';
            this.messageInputActive.style.height = 'auto';
            this.updateSendButton(this.messageInputActive, this.sendButtonActive);
            
            // Show typing indicator
            this.showTypingIndicator();
            
            // Scroll to latest message
            this.scrollToLatestMessage();
            
            // Simulate AI response
            await this.simulateAIResponse();
        }
        
        addMessage(content, type = 'user') {
            const messageDiv = document.createElement('div');
            messageDiv.className = `message-appear ${type === 'user' ? 'flex justify-end' : 'flex justify-start'}`;
            
            const messageBubble = document.createElement('div');
            if (type === 'user') {
                messageBubble.className = 'bg-green-600 text-white px-4 py-3 rounded-2xl max-w-xs lg:max-w-2xl break-words whitespace-pre-wrap';
            } else {
                messageBubble.className = 'bg-gray-100 border border-gray-300 text-gray-800 px-4 py-3 rounded-2xl max-w-xs lg:max-w-2xl shadow-sm break-words whitespace-pre-wrap';
            }
            
            messageBubble.textContent = content;
            messageDiv.appendChild(messageBubble);
            
            this.messagesList.appendChild(messageDiv);
        }
        
        showTypingIndicator() {
            this.isTyping = true;
            this.updateSendButton(this.messageInputActive, this.sendButtonActive);
            
            const typingDiv = document.createElement('div');
            typingDiv.id = 'typingIndicator';
            typingDiv.className = 'flex justify-start message-appear';
            
            const typingBubble = document.createElement('div');
            typingBubble.className = 'bg-gray-100 border border-gray-300 px-4 py-3 rounded-2xl shadow-sm typing-indicator';
            
            const dotsContainer = document.createElement('div');
            dotsContainer.className = 'typing-dots flex space-x-1';
            
            for (let i = 0; i < 3; i++) {
                const dot = document.createElement('span');
                dot.className = 'w-2 h-2 bg-gray-400 rounded-full inline-block';
                dotsContainer.appendChild(dot);
            }
            
            typingBubble.appendChild(dotsContainer);
            typingDiv.appendChild(typingBubble);
            
            this.messagesList.appendChild(typingDiv);
            this.scrollToLatestMessage();
        }
        
        hideTypingIndicator() {
            const typingIndicator = document.getElementById('typingIndicator');
            if (typingIndicator) {
                typingIndicator.remove();
            }
            this.isTyping = false;
            this.updateSendButton(this.messageInputActive, this.sendButtonActive);
        }
        
        /* IMPORTANT: Papalitan yung simulateAIresponse kapag may actual AI response na, eto ipapalit natin dito:

         async callActualAI() {
    try {
        // Call your Django backend
        const response = await fetch('/api/chat/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
            },
            body: JSON.stringify({
                message: this.lastUserMessage,
                conversation_id: this.conversationId // if you track conversations
            })
        });
        
        const data = await response.json();
        
        this.hideTypingIndicator();
        this.addMessage(data.ai_response, 'assistant');
        
    } catch (error) {
        this.hideTypingIndicator();
        this.addMessage("Sorry, I'm having trouble connecting. Please try again.", 'assistant');
    }
} */

        async simulateAIResponse() {
            await new Promise(resolve => setTimeout(resolve, 1500 + Math.random() * 1500));
            
            this.hideTypingIndicator();
            
            // Sample responses
            const responses = [
                "Yoko nga bala ka dyan",
                "Ganto muna placeholder since wala pa tayu bot",
                "Bla bla bla",
            ];
            
            const randomResponse = responses[Math.floor(Math.random() * responses.length)];
            this.addMessage(randomResponse, 'assistant');
            this.scrollToLatestMessage();
        }
        
        scrollToLatestMessage() {
            setTimeout(() => {
                const lastMessage = this.messagesList.lastElementChild;
                if (lastMessage) {
                    // Eto ung script para ma-scroll sa pinaka-latest na message ng bot kaya wag galawen hehe
                    const messageTop = lastMessage.offsetTop;
                    const conversationSectionTop = this.conversationSection.offsetTop;
                    const targetScrollPosition = conversationSectionTop + messageTop - 50;
                    
                    window.scrollTo({
                        top: targetScrollPosition,
                        behavior: 'smooth'
                    });
                }
            }, 100);
        }
    }
    
    //Magloload lang ung interface ng chat kapag meron nang input si user
    document.addEventListener('DOMContentLoaded', () => {
        new ChatInterface();
    });
})();
</script>
{% endblock %}